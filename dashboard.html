<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Dashboard Â· TrackMyPaisa</title>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
*{
  box-sizing:border-box;
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto;
}
body{
  margin:0;
  min-height:100vh;
  background:linear-gradient(180deg,#14162a,#0f1120);
  color:#fff;
}

/* CONTAINER */
.container{
  max-width:430px;
  margin:auto;
  padding:20px 16px 40px;
}

/* HEADER */
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:linear-gradient(135deg,#1c1f3a,#23265a);
  border-radius:22px;
  padding:16px;
  margin-bottom:18px;
}
.profile{
  display:flex;
  gap:12px;
  align-items:center;
}
.avatar{
  width:46px;
  height:46px;
  border-radius:50%;
  background:linear-gradient(135deg,#6c7bff,#8f9dff);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:600;
}
.header-text small{
  opacity:.75;
  font-size:13px;
}
.header-text div{
  font-size:14px;
  font-weight:500;
}
.logout{
  background:transparent;
  border:1px solid rgba(255,255,255,.3);
  color:#fff;
  padding:8px 14px;
  border-radius:20px;
  cursor:pointer;
}

/* CARD */
.card{
  background:linear-gradient(180deg,#1a1d33,#151728);
  border-radius:24px;
  padding:18px;
  margin-bottom:18px;
}
.card h3{
  margin:0 0 14px;
  font-size:18px;
}

/* INPUTS */
input,select{
  width:100%;
  padding:14px;
  margin-bottom:12px;
  border-radius:16px;
  border:none;
  outline:none;
  background:#fff;
  font-size:15px;
}

/* BUTTON */
.primary-btn{
  width:100%;
  padding:14px;
  border-radius:18px;
  border:none;
  font-size:15px;
  font-weight:600;
  color:#fff;
  cursor:pointer;
  background:linear-gradient(135deg,#6c7bff,#8f9dff);
}

/* CHART */
.chart-box{
  height:240px;
  display:flex;
  justify-content:center;
  align-items:center;
}
canvas{
  max-width:100%;
}
</style>
</head>

<body>

<div class="container">

  <!-- HEADER -->
  <div class="header">
    <div class="profile">
      <div class="avatar" id="avatar">U</div>
      <div class="header-text">
        <small id="greet">Hello</small>
        <div id="userEmail">user@email.com</div>
      </div>
    </div>
    <button class="logout" id="logoutBtn">Logout</button>
  </div>

  <!-- ADD EXPENSE -->
  <div class="card">
    <h3>Add Expense</h3>
    <input type="number" id="amount" placeholder="Amount â‚¹">
    <input type="text" id="note" placeholder="Note">
    <select id="category">
      <option>Food</option>
      <option>Travel</option>
      <option>Shopping</option>
      <option>Bills</option>
      <option>Other</option>
    </select>
    <button class="primary-btn" id="addExpense">Save Expense</button>
  </div>

  <!-- MONTH FILTER -->
  <div class="card">
    <select id="monthFilter"></select>
  </div>

  <!-- CHART -->
  <div class="card">
    <h3>Category Breakdown</h3>
    <div class="chart-box">
      <canvas id="pieChart"></canvas>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
/* ðŸ”¥ FIREBASE CONFIG (same project) */
firebase.initializeApp({
  apiKey: "YOUR_API_KEY",
  authDomain: "expense-tracker-b2038.firebaseapp.com",
  projectId: "expense-tracker-b2038"
});

const auth = firebase.auth();
const db = firebase.firestore();

/* AUTH CHECK */
auth.onAuthStateChanged(user=>{
  if(!user){
    window.location.href="login.html";
    return;
  }

  document.getElementById("userEmail").innerText = user.email;
  document.getElementById("avatar").innerText = user.email[0].toUpperCase();

  setGreeting();
  loadMonths(user.uid);
});

/* GREETING */
function setGreeting(){
  const h=new Date().getHours();
  document.getElementById("greet").innerText =
    h<12?"Good Morning":h<18?"Good Afternoon":"Good Evening";
}

/* LOGOUT */
document.getElementById("logoutBtn").onclick=()=>{
  auth.signOut().then(()=>{
    window.location.href="login.html";
  });
};

/* ADD EXPENSE */
document.getElementById("addExpense").onclick=()=>{
  const user=auth.currentUser;
  const amt=amount.value;
  const noteVal=note.value;
  const cat=category.value;

  if(!amt) return alert("Enter amount");

  db.collection("users").doc(user.uid).collection("expenses").add({
    amount:Number(amt),
    note:noteVal,
    category:cat,
    createdAt:firebase.firestore.FieldValue.serverTimestamp()
  }).then(()=>{
    amount.value="";
    note.value="";
    loadMonths(user.uid);
  });
};

/* LOAD MONTHS */
function loadMonths(uid){
  const sel=document.getElementById("monthFilter");
  sel.innerHTML="";
  db.collection("users").doc(uid).collection("expenses")
  .orderBy("createdAt","desc").get().then(snap=>{
    const months=new Set();
    snap.forEach(d=>{
      if(d.data().createdAt){
        const dt=d.data().createdAt.toDate();
        months.add(dt.getMonth()+"-"+dt.getFullYear());
      }
    });
    [...months].forEach(m=>{
      const [mo,yr]=m.split("-");
      const opt=document.createElement("option");
      opt.value=m;
      opt.text=`${new Date(yr,mo).toLocaleString('default',{month:'long'})} ${yr}`;
      sel.appendChild(opt);
    });
    if(sel.value) loadChart(uid,sel.value);
  });
}

document.getElementById("monthFilter").onchange=()=>{
  loadChart(auth.currentUser.uid,monthFilter.value);
};

/* CHART */
let chart;
function loadChart(uid,key){
  db.collection("users").doc(uid).collection("expenses").get().then(snap=>{
    const data={};
    snap.forEach(d=>{
      if(!d.data().createdAt) return;
      const dt=d.data().createdAt.toDate();
      const k=dt.getMonth()+"-"+dt.getFullYear();
      if(k!==key) return;
      data[d.data().category]=(data[d.data().category]||0)+d.data().amount;
    });
    renderChart(data);
  });
}

function renderChart(data){
  if(chart) chart.destroy();
  chart=new Chart(document.getElementById("pieChart"),{
    type:"pie",
    data:{
      labels:Object.keys(data),
      datasets:[{
        data:Object.values(data),
        backgroundColor:["#6c7bff","#4cd964","#ff9500","#ff3b30","#9b59b6"]
      }]
    },
    options:{
      plugins:{legend:{labels:{color:"#fff"}}}
    }
  });
}
</script>

</body>
</html>
